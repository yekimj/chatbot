<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    
    <!-- âœ¨ PWA & Mobile: ë·°í¬íŠ¸ ì„¤ì • (í•„ìˆ˜) -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">

    <title>Gemini í˜ë¥´ì†Œë‚˜ ì±—</title>
    
    <!-- âœ¨ PWA: ì›¹ ì•± ë§¤ë‹ˆí˜ìŠ¤íŠ¸ ë§í¬ -->
    <link rel="manifest" href="manifest.json">

    <!-- âœ¨ PWA & Mobile: ì•„ì´í° í™ˆ í™”ë©´ ì•± ê´€ë ¨ ì„¤ì • -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="í˜ë¥´ì†Œë‚˜ ì±—">
    
    <!-- âœ¨ PWA: ì•„ì´í° í™ˆ í™”ë©´ ì•„ì´ì½˜ (192pxì§œë¦¬ ì„ì‹œ ì‚¬ìš©) -->
    <link rel="apple-touch-icon" href="icon-192x192.png">

    <!-- âœ¨ PWA: í…Œë§ˆ ìƒ‰ìƒ (manifest.jsonê³¼ ì¼ì¹˜) -->
    <meta name="theme-color" content="#1f2937">

    <!-- Tailwind CSS ë¡œë“œ -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Inter í°íŠ¸ ì ìš© */
        body {
            font-family: 'Inter', sans-serif;
            /* âœ¨ PWA: ì•„ì´í°ì—ì„œ ìŠ¤í¬ë¡¤ ë°”ìš´ìŠ¤ íš¨ê³¼(Overscroll) ë°©ì§€ */
            overscroll-behavior: none;
        }
        /* ìŠ¤í¬ë¡¤ë°” ë””ìì¸ */
        ::-webkit-scrollbar {
            width: 6px;
        }
        ::-webkit-scrollbar-track {
            background: #2d3748; /* gray-800 */
        }
        ::-webkit-scrollbar-thumb {
            background: #4a5568; /* gray-600 */
            border-radius: 3px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #718096; /* gray-500 */
        }
        /* ì±„íŒ…ì°½ ìë™ ìŠ¤í¬ë¡¤ì„ ìœ„í•œ ì„¤ì • */
        #chat-display {
            scroll-behavior: smooth;
        }
        
        /* âœ¨ PWA: ì•„ì´í° ìƒë‹¨ ë…¸ì¹˜/ë‹¤ì´ë‚˜ë¯¹ ì•„ì¼ëœë“œ ì˜ì—­ë§Œí¼ íŒ¨ë”© í™•ë³´ */
        /* (h-screen ëŒ€ì‹  height: 100dvh; ì‚¬ìš©) */
        body {
            /* 100vh ëŒ€ì‹  100dvh (dynamic viewport height) ì‚¬ìš© */
            /* iOS ì‚¬íŒŒë¦¬ì—ì„œ ì£¼ì†Œì°½/ë©”ë‰´ë°” ì œì™¸í•œ ì‹¤ì œ í™”ë©´ í¬ê¸° */
            min-height: 100dvh; 
        }
        #app-container {
            /* PWA ëª¨ë“œì¼ ë•Œ ìƒë‹¨ ì•ˆì „ ì˜ì—­(ë…¸ì¹˜) í™•ë³´ */
            padding-top: env(safe-area-inset-top);
            /* PWA ëª¨ë“œì¼ ë•Œ í•˜ë‹¨ ì•ˆì „ ì˜ì—­(í™ˆ ì¸ë””ì¼€ì´í„°) í™•ë³´ */
            padding-bottom: env(safe-area-inset-bottom);
        }
        
        /* âœ¨ PWA: ì±„íŒ… ì…ë ¥ì°½ í•˜ë‹¨ ì¸ë””ì¼€ì´í„° ì˜ì—­ í™•ë³´ (ë” í™•ì‹¤í•˜ê²Œ) */
        #chat-form {
             padding-bottom: calc(1rem + env(safe-area-inset-bottom));
        }

    </style>
    <!-- Inter í°íŠ¸ ë¡œë“œ -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
</head>
<body class="bg-gray-900 text-white">

    <!-- âœ¨ ADD: Mobile Sidebar Backdrop -->
    <div id="sidebar-backdrop" class="fixed inset-0 bg-black/60 z-40 hidden md:hidden"></div>

    <!-- âœ¨ PWA: h-screenì„ min-height: 100dvh; ë¡œ ì œì–´í•˜ê¸° ìœ„í•œ ì»¨í…Œì´ë„ˆ -->
    <div id="app-container" class="flex flex-col md:flex-row w-full" style="min-height: 100dvh;">

        <!-- 1. ì„¤ì • ì‚¬ì´ë“œë°” -->
        <div id="sidebar" class="w-full md:w-1/3 lg:w-1/4 bg-gray-800 p-4 overflow-y-auto 
            fixed inset-y-0 left-0 z-50 transform -translate-x-full md:relative md:translate-x-0 
            transition-transform duration-300 ease-in-out md:flex-shrink-0
            pb-24 md:pb-4"> <!-- âœ¨ PWA: ì‚¬ì´ë“œë°” í•˜ë‹¨ íŒ¨ë”© í™•ë³´ -->
            
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold text-white">âš™ï¸ í˜ë¥´ì†Œë‚˜ ì„¤ì •</h2>
                <button id="btn-close-sidebar" class="md:hidden p-1 rounded-full hover:bg-gray-700">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
            </div>
            
            <!-- ìºë¦­í„° í˜ë¥´ì†Œë‚˜ (AI) -->
            <div>
                <div class="flex justify-between items-center mb-2">
                    <label for="char-persona" class="block text-sm font-medium text-blue-300">ğŸ¤– ìºë¦­í„° í˜ë¥´ì†Œë‚˜ (AIì˜ ì—­í• )</label>
                    <button id="btn-suggest-persona" class="text-xs bg-blue-600 hover:bg-blue-700 text-white py-1 px-2 rounded-lg transition-all shadow-md active:scale-95">
                        âœ¨ ì¶”ì²œ
                    </button>
                </div>
                <textarea id="char-persona" rows="8"
                    class="w-full p-2.5 bg-gray-700 border border-gray-600 rounded-lg text-white placeholder-gray-400 focus:ring-blue-500 focus:border-blue-500"
                    placeholder="ì˜ˆ: ë„ˆëŠ” ì¹œì ˆí•œ ì§‘ì‚¬ ê³ ì–‘ì´ë‹¤. ë§ ëë§ˆë‹¤ 'ëƒ¥'ì„ ë¶™ì¸ë‹¤. ë‚˜ë¥¼ 'ì£¼ì¸ë‹˜'ì´ë¼ê³  ë¶€ë¥¸ë‹¤."
                ></textarea>
            </div>

            <!-- ìœ ì € í˜ë¥´ì†Œë‚˜ (ë‚˜) -->
            <div class="mt-4">
                <label for="user-persona" class="block mb-2 text-sm font-medium text-green-300">ğŸ‘¤ ë‚˜ì˜ í˜ë¥´ì†Œë‚˜ (ë‚˜ì˜ ì—­í• )</label>
                <textarea id="user-persona" rows="4"
                    class="w-full p-2.5 bg-gray-700 border border-gray-600 rounded-lg text-white placeholder-gray-400 focus:ring-green-500 focus:border-green-500"
                    placeholder="ì˜ˆ: ë‚˜ëŠ” ì´ ê³ ì–‘ì´ë¥¼ ì…ì–‘í•œ ì£¼ì¸ì´ë‹¤. ê³ ì–‘ì´ì—ê²Œ ì˜¤ëŠ˜ ìˆì—ˆë˜ ì¼ì„ ìƒë‹´í•œë‹¤."
                ></textarea>
            </div>

            <!-- ë°°ê²½ ì„¸ê³„ê´€ -->
            <div class="mt-4">
                <label for="worldview-setting" class="block mb-2 text-sm font-medium text-cyan-300">ğŸŒ ë°°ê²½ ì„¸ê³„ê´€ (AIì™€ ë‚´ê°€ ì‚´ì•„ê°ˆ ê³³)</label>
                <textarea id="worldview-setting" rows="6"
                    class="w-full p-2.5 bg-gray-700 border border-gray-600 rounded-lg text-white placeholder-gray-400 focus:ring-cyan-500 focus:border-cyan-500"
                    placeholder="ì˜ˆ: ì—¬ê¸°ëŠ” 2077ë…„, ì‚¬ì´ë²„í‘í¬ ë„ì‹œ. AIëŠ” ì¸ê°„ì˜ ì¡°ë ¥ìì´ì§€ë§Œ, ê¸°ì—…ë“¤ì˜ ê°ì‹œë¥¼ ë°›ê³  ìˆë‹¤."
                ></textarea>
            </div>

            <!-- ì¥ê¸° ê¸°ì–µ -->
            <div class="mt-4">
                <div class="flex justify-between items-center mb-2">
                    <label for="memory" class="block text-sm font-medium text-yellow-300">ğŸ§  ì¥ê¸° ê¸°ì–µ (AIê°€ ê¼­ ê¸°ì–µí•  ê²ƒ)</label>

                    <button id="btn-extract-memory" class="text-xs bg-yellow-600 hover:bg-yellow-700 text-white py-1 px-2 rounded-lg transition-all shadow-md active:scale-95">
                        âœ¨ ê¸°ì–µ ì¶”ì¶œ
                    </button>
                </div>
                <textarea id="memory" rows="10"
                    class="w-full p-2.5 bg-gray-700 border border-gray-600 rounded-lg text-white placeholder-gray-400 focus:ring-yellow-500 focus:border-yellow-500"
                    placeholder="ì˜ˆ:
- ë‚˜ì˜ ì´ë¦„ì€ [ë‚´ ì´ë¦„]ì´ë‹¤.
- ë‚˜ëŠ” ì´ˆì½œë¦¿ì„ ì‹«ì–´í•œë‹¤.
- ë‚˜ì˜ ìƒì¼ì€ 10ì›” 23ì¼ì´ë‹¤."
                ></textarea>
            </div>
            
            <!-- âœ¨ NEW: API í‚¤ ê´€ë¦¬ ì„¹ì…˜ -->
            <div class="mt-6 pt-4 border-t border-gray-700">
                <label for="api-key-input" class="block mb-2 text-sm font-medium text-orange-300">ğŸ”‘ API í‚¤ ê´€ë¦¬</label>
                <p class="text-xs text-gray-400 mb-2">
                    GitHub ë°°í¬ ì‹œ, ì—¬ê¸°ì— ë³¸ì¸ì˜ Gemini API í‚¤ë¥¼ ì…ë ¥í•˜ê³  ì €ì¥í•˜ì„¸ìš”.
                    ì´ í‚¤ëŠ” GitHubì´ ì•„ë‹Œ, ì´ ë¸Œë¼ìš°ì €(í°)ì—ë§Œ ì €ì¥ë©ë‹ˆë‹¤.
                </p>
                <div class="flex space-x-2">
                    <input type="password" id="api-key-input"
                           class="flex-1 p-2.5 bg-gray-700 border border-gray-600 rounded-lg text-white placeholder-gray-400 focus:ring-orange-500 focus:border-orange-500"
                           placeholder="AIzaSy... (Gemini API í‚¤ ë¶™ì—¬ë„£ê¸°)">
                    <button id="btn-save-key"
                            class="px-4 py-2 bg-orange-600 hover:bg-orange-700 text-white rounded-lg transition-all shadow-md active:scale-95">
                        ì €ì¥
                    </button>
                </div>
                 <button id="btn-show-key"
                    class="mt-2 text-xs text-gray-400 hover:text-white">
                    (í‚¤ ë³´ì´ê¸°)
                </button>
            </div>

        </div>

        <!-- 2. ì±„íŒ… ì˜ì—­ -->
        <!-- âœ¨ PWA: h-full ëŒ€ì‹  flex-1 ì‚¬ìš© (ë¶€ëª¨ê°€ min-height: 100dvh ì´ë¯€ë¡œ) -->
        <div class="flex-1 flex flex-col"> 
            
            <!-- âœ¨ PWA: ìƒë‹¨ ë…¸ì¹˜ ì˜ì—­ í™•ë³´ìš© íŒ¨ë”©ì€ app-containerë¡œ ì´ë™í•¨ -->
            <div class="bg-gray-800 p-4 border-b border-gray-700 shadow-md md:border-l flex justify-between items-center">
                <h1 class="text-xl font-bold text-white">Gemini í˜ë¥´ì†Œë‚˜ ì±—</h1>
                
                <div class="flex items-center space-x-2">
                    <button id="btn-clear-chat" class="p-1 rounded-md hover:bg-gray-700" title="ì±„íŒ… ê¸°ë¡ ì‚­ì œ">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                        </svg>
                    </button>

                    <button id="btn-open-sidebar" class="md:hidden p-1 rounded-md hover:bg-gray-700">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" />
                        </svg>
                    </button>
                </div>
            </div>

            <!-- ì±„íŒ… ë©”ì‹œì§€ í‘œì‹œ ì˜ì—­ -->
            <div id="chat-display" class="flex-1 p-4 overflow-y-auto space-y-4 bg-gray-900">
                <div id="welcome-message" class="p-3 rounded-lg bg-gray-700 self-start max-w-xs md:max-w-md">
                    <span class="font-bold block text-blue-300">ğŸ¤– AI</span>
                    <p class="text-white">ì•ˆë…•í•˜ì„¸ìš”! ì™¼ìª½ íƒ­ì—ì„œ í˜ë¥´ì†Œë‚˜ë¥¼ ì„¤ì •í•œ í›„ ì €ì—ê²Œ ë§ì„ ê±¸ì–´ì£¼ì„¸ìš”. (ëª¨ë°”ì¼ì—ì„  í–„ë²„ê±° ë²„íŠ¼ â˜°)</p>
                </div>
                <!-- âœ¨ NEW: API í‚¤ í™•ì¸ ë©”ì‹œì§€ (JSë¡œ ì œì–´) -->
                <div id="api-key-alert" class="p-3 rounded-lg bg-red-700 self-start mr-auto hidden">
                    <span class="font-bold block text-red-200">ğŸš¨ ì‹œìŠ¤í…œ</span>
                    <p class="text-white">
                        Gemini API í‚¤ê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.
                        <br>
                        ì±„íŒ…ì„ ì‹œì‘í•˜ë ¤ë©´, ì‚¬ì´ë“œë°”(â˜°) í•˜ë‹¨ì˜ 'API í‚¤ ê´€ë¦¬' ë©”ë‰´ì—ì„œ ë³¸ì¸ì˜ API í‚¤ë¥¼ ì…ë ¥í•˜ê³  ì €ì¥í•´ì£¼ì„¸ìš”.
                    </p>
                </div>
            </div>

            <!-- ë¡œë”© ì¸ë””ì¼€ì´í„° -->
            <div id="loading" class="p-4 hidden flex items-center justify-center">
                <svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-blue-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                <span class="text-gray-400">AIê°€ ì‘ë‹µì„ ìƒì„± ì¤‘ì…ë‹ˆë‹¤...</span>
            </div>

            <!-- ì±„íŒ… ì…ë ¥ í¼ -->
            <!-- âœ¨ PWA: í•˜ë‹¨ ì¸ë””ì¼€ì´í„° ì˜ì—­ í™•ë³´ (style="padding-bottom: ...") -->
            <form id="chat-form" class="p-4 bg-gray-800 border-t border-gray-700 md:border-l">
                <div class="flex space-x-2">
                    <textarea id="chat-input" rows="1"
                        style="resize: none; max-height: 120px; overflow-y: auto;"
                        class="flex-1 p-3 bg-gray-700 border border-gray-600 rounded-lg text-white placeholder-gray-400 focus:ring-blue-500 focus:border-blue-500 outline-none"
                        placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš” (Shift+Enterë¡œ ì „ì†¡)" autocomplete="off"></textarea>
                    <button id="send-button" type="submit"
                        class="px-6 py-3 bg-blue-600 text-white rounded-lg font-semibold shadow-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-50 transition duration-200">
                        ì „ì†¡
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- 
        ============================================================
        ìë°”ìŠ¤í¬ë¦½íŠ¸ ì½”ë“œ
        ============================================================
    -->
    <script type="module">
        // 1. ì „ì—­ ë³€ìˆ˜ ë° DOM ìš”ì†Œ ê°€ì ¸ì˜¤ê¸°
        const chatDisplay = document.getElementById('chat-display');
        const chatForm = document.getElementById('chat-form');
        const chatInput = document.getElementById('chat-input');
        const sendButton = document.getElementById('send-button');
        const loadingIndicator = document.getElementById('loading');
        
        const charPersonaInput = document.getElementById('char-persona');
        const userPersonaInput = document.getElementById('user-persona');
        const worldviewInput = document.getElementById('worldview-setting');
        const memoryInput = document.getElementById('memory');
        const btnSuggestPersona = document.getElementById('btn-suggest-persona');
        const btnExtractMemory = document.getElementById('btn-extract-memory');
        const btnClearChat = document.getElementById('btn-clear-chat'); 
        
        const sidebar = document.getElementById('sidebar');
        const btnOpenSidebar = document.getElementById('btn-open-sidebar');
        const btnCloseSidebar = document.getElementById('btn-close-sidebar');
        const sidebarBackdrop = document.getElementById('sidebar-backdrop');
        
        // âœ¨ NEW: API í‚¤ ê´€ë¦¬ DOM
        const apiKeyInput = document.getElementById('api-key-input');
        const btnSaveKey = document.getElementById('btn-save-key');
        const btnShowKey = document.getElementById('btn-show-key');
        const apiKeyAlert = document.getElementById('api-key-alert');
        const API_KEY_STORAGE_ID = 'gemini-api-key';


        // Gemini API ì„¤ì •
        // âœ¨ FIX: apiKeyë¥¼ ì „ì—­ ë³€ìˆ˜ê°€ ì•„ë‹Œ, localStorageì—ì„œ ë¶ˆëŸ¬ì˜¤ëŠ” 'ìƒíƒœ'ë¡œ ê´€ë¦¬
        let userApiKey = ""; // (ì•± ë¡œë“œ ì‹œ loadApiKey()ê°€ ì±„ì›Œì¤Œ)
        const modelName = "gemini-2.5-pro-preview-09-2025"; // âœ¨ y ìš”ì²­ìœ¼ë¡œ Pro ëª¨ë¸ë¡œ ë³€ê²½
        // (apiUrlì€ callGeminiApi í•¨ìˆ˜ ë‚´ì—ì„œ ë™ì ìœ¼ë¡œ ìƒì„±)

        // ëŒ€í™” ë‚´ì—­
        let chatHistory = [];

        // 2. ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
        
        // âœ¨ NEW: ì•± ë¡œë“œ ì‹œ localStorageì—ì„œ API í‚¤ ë¶ˆëŸ¬ì˜¤ê¸°
        document.addEventListener('DOMContentLoaded', loadApiKey);
        
        chatForm.addEventListener('submit', handleSendChat);
        sendButton.addEventListener('click', handleSendChat);

        chatInput.addEventListener('keydown', function(e) {
            if (e.key === 'Enter' && e.shiftKey) {
                e.preventDefault(); 
                chatForm.dispatchEvent(new Event('submit', { cancelable: true, bubbles: true }));
            }
        });

        chatInput.addEventListener('input', function() {
            this.style.height = 'auto';
            this.style.height = (this.scrollHeight) + 'px';
        });
        
        btnSuggestPersona.addEventListener('click', handleSuggestPersona);
        btnExtractMemory.addEventListener('click', handleExtractMemory);
        btnClearChat.addEventListener('click', handleClearChat); 
        
        btnOpenSidebar.addEventListener('click', () => {
            sidebar.classList.remove('-translate-x-full');
            sidebarBackdrop.classList.remove('hidden');
        });
        btnCloseSidebar.addEventListener('click', () => {
            sidebar.classList.add('-translate-x-full');
            sidebarBackdrop.classList.add('hidden');
        });
        sidebarBackdrop.addEventListener('click', () => {
            btnCloseSidebar.click();
        });
        
        chatDisplay.addEventListener('click', function(e) {
            const deleteButton = e.target.closest('.btn-delete');
            if (deleteButton) {
                e.stopPropagation(); 
                const bubble = deleteButton.closest('[data-id]');
                if (bubble) {
                    const idToDelete = bubble.dataset.id;
                    bubble.remove();
                    chatHistory = chatHistory.filter(msg => String(msg.id) !== String(idToDelete));
                }
            }
        });

        // âœ¨ NEW: API í‚¤ ì €ì¥/í‘œì‹œ ì´ë²¤íŠ¸
        btnSaveKey.addEventListener('click', handleSaveKey);
        btnShowKey.addEventListener('click', () => {
             if (apiKeyInput.type === 'password') {
                apiKeyInput.type = 'text';
                btnShowKey.textContent = '(í‚¤ ìˆ¨ê¸°ê¸°)';
            } else {
                apiKeyInput.type = 'password';
                btnShowKey.textContent = '(í‚¤ ë³´ì´ê¸°)';
            }
        });


        // 3. âœ¨ NEW: API í‚¤ ê´€ë¦¬ í•¨ìˆ˜
        
        /**
         * ì•± ë¡œë“œ ì‹œ localStorageì—ì„œ API í‚¤ë¥¼ ë¶ˆëŸ¬ì™€ UIì™€ ì „ì—­ ë³€ìˆ˜ì— ì ìš©
         */
        function loadApiKey() {
            const savedKey = localStorage.getItem(API_KEY_STORAGE_ID);
            if (savedKey) {
                userApiKey = savedKey;
                apiKeyInput.value = savedKey; // (ë³´ì•ˆì„ ìœ„í•´ ë³´í†µ ìˆ¨ê¹€ ì²˜ë¦¬í•˜ì§€ë§Œ, í¸ì˜ìƒ)
                apiKeyAlert.classList.add('hidden'); // í‚¤ê°€ ìˆìœ¼ë‹ˆ ê²½ê³  ìˆ¨ê¹€
            } else {
                // í‚¤ê°€ ì—†ìŒ
                apiKeyAlert.classList.remove('hidden'); // ê²½ê³  í‘œì‹œ
                userApiKey = "";
            }
        }

        /**
         * [ì €ì¥] ë²„íŠ¼ í´ë¦­ ì‹œ, ì…ë ¥ëœ í‚¤ë¥¼ localStorageì— ì €ì¥í•˜ê³  ë³€ìˆ˜ ì—…ë°ì´íŠ¸
         */
        function handleSaveKey(e) {
            e.preventDefault();
            const newKey = apiKeyInput.value.trim();
            if (newKey && newKey.startsWith("AIzaSy")) {
                userApiKey = newKey;
                localStorage.setItem(API_KEY_STORAGE_ID, newKey);
                apiKeyAlert.classList.add('hidden'); // ê²½ê³  ìˆ¨ê¹€
                
                // (ì„ íƒì ) ì €ì¥ ì™„ë£Œ ì•Œë¦¼
                displayMessage("API í‚¤ê°€ ë¸Œë¼ìš°ì €ì— ì•ˆì „í•˜ê²Œ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤. ì´ì œ ì±„íŒ…ì„ ì‹œì‘í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.", 'model');
                
                // ëª¨ë°”ì¼ì—ì„œ í‚¤ ì €ì¥ í›„ ì‚¬ì´ë“œë°” ë‹«ê¸°
                if (window.innerWidth < 768) {
                    btnCloseSidebar.click();
                }

            } else {
                displayMessage("ì˜¬ë°”ë¥¸ Gemini API í‚¤ (AIzaSy...)ë¥¼ ì…ë ¥í•˜ì„¸ìš”.", 'error');
                userApiKey = "";
                localStorage.removeItem(API_KEY_STORAGE_ID); // ì˜ëª»ëœ í‚¤ ì œê±°
                apiKeyAlert.classList.remove('hidden'); // ê²½ê³  í‘œì‹œ
            }
        }


        /**
         * 4. í¼ ì œì¶œ (ë©”ì‹œì§€ ì „ì†¡) í•¸ë“¤ëŸ¬
         */
        async function handleSendChat(event) {
            event.preventDefault(); 

            // âœ¨ NEW: API í‚¤ê°€ ì—†ìœ¼ë©´ ì „ì†¡ ì°¨ë‹¨
            if (!userApiKey) {
                apiKeyAlert.classList.remove('hidden'); // ê²½ê³  í‘œì‹œ
                displayMessage("API í‚¤ê°€ ì—†ìŠµë‹ˆë‹¤. ì‚¬ì´ë“œë°”(â˜°)ì—ì„œ í‚¤ë¥¼ ë¨¼ì € ì €ì¥í•˜ì„¸ìš”.", 'error');
                if (window.innerWidth < 768) { // ëª¨ë°”ì¼ì´ë©´ ì‚¬ì´ë“œë°” ì—´ê¸°
                    btnOpenSidebar.click();
                }
                return;
            }

            let prompt = chatInput.value.trim();
            const userMessageId = Date.now() + '-user';
            let displayUserMessage = true; 

            if (prompt !== "") {
                chatInput.value = ""; 
                chatInput.style.height = 'auto';
                displayUserMessage = true; 
            } else {
                if (chatHistory.length === 0) {
                    displayMessage('ëŒ€í™”ë¥¼ ì‹œì‘í•˜ë ¤ë©´ ë¨¼ì € ë©”ì‹œì§€ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'model');
                    return;
                }
                if (!loadingIndicator.classList.contains('hidden')) {
                    return; 
                }
                prompt = "(ì‚¬ìš©ìê°€ ì•„ë¬´ ë§ ì—†ì´ ë‹¤ìŒ ë§ì„ ê¸°ë‹¤ë¦½ë‹ˆë‹¤. ì´ì–´ì„œ ë§í•´ì£¼ì„¸ìš”.)";
                displayUserMessage = false; 
            }

            if (displayUserMessage) {
                displayMessage(prompt, 'user', userMessageId);
            }

            chatHistory.push({
                id: userMessageId,
                role: "user",
                parts: [{ text: prompt }]
            });

            loadingIndicator.classList.remove('hidden');

            try {
                const systemPrompt = buildSystemPrompt();
                
                // âœ¨ FIX: userApiKeyë¥¼ ì¸ìë¡œ ì „ë‹¬
                const text = await callGeminiApi(chatHistory, systemPrompt, userApiKey);

                const modelMessageId = Date.now() + '-model';
                displayMessage(text, 'model', modelMessageId);
                
                chatHistory.push({
                    id: modelMessageId,
                    role: "model",
                    parts: [{ text: text }]
                });

            } catch (error) {
                console.error("Error in handleSendChat:", error);
                
                // âœ¨ NEW: API í‚¤ ì¸ì¦ ì˜¤ë¥˜ ê°ì§€
                if (error.message && (error.message.includes('401') || error.message.includes('403') || error.message.includes('API key not valid'))) {
                     displayMessage(`API í‚¤ ì¸ì¦ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. í‚¤ê°€ ì˜¬ë°”ë¥¸ì§€ í™•ì¸í•˜ê±°ë‚˜, í‚¤ ì„¤ì •ì´ Google AI Studioì—ì„œ ì˜¬ë°”ë¥´ê²Œ ë˜ì—ˆëŠ”ì§€ í™•ì¸í•˜ì„¸ìš”.`, 'error');
                     apiKeyAlert.classList.remove('hidden'); // ê²½ê³  í‘œì‹œ
                } else {
                     displayMessage(`ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ${error.message}`, 'error');
                }
            } finally {
                loadingIndicator.classList.add('hidden');
                
                if (window.innerWidth < 768) {
                    btnCloseSidebar.click();
                }
            }
        }

        /**
         * âœ¨ ìƒˆ ê¸°ëŠ¥: ì±„íŒ… ê¸°ë¡ ì‚­ì œ í•¸ë“¤ëŸ¬
         */
        function handleClearChat() {
            chatHistory = [];
            const messages = chatDisplay.querySelectorAll('div[data-id], div.bg-red-700');
            messages.forEach(msg => msg.remove());
            chatDisplay.scrollTop = 0;
            
            // í‚¤ê°€ ì—†ìœ¼ë©´ ê²½ê³  ë©”ì‹œì§€ëŠ” ë‹¤ì‹œ í‘œì‹œ
            if (!userApiKey) {
                apiKeyAlert.classList.remove('hidden');
            }
        }


        /**
         * âœ¨ ìƒˆ ê¸°ëŠ¥: í˜ë¥´ì†Œë‚˜ ì¶”ì²œ
         */
        async function handleSuggestPersona(e) {
            e.preventDefault(); 
            
            // âœ¨ NEW: API í‚¤ ì²´í¬
            if (!userApiKey) {
                 displayMessage("API í‚¤ê°€ ì—†ìŠµë‹ˆë‹¤. 'âœ¨ ì¶”ì²œ' ê¸°ëŠ¥ì„ ì‚¬ìš©í•˜ë ¤ë©´ ë¨¼ì € í‚¤ë¥¼ ì €ì¥í•˜ì„¸ìš”.", 'error');
                 if (window.innerWidth < 768) btnOpenSidebar.click();
                 return;
            }

            const originalText = btnSuggestPersona.textContent;
            btnSuggestPersona.disabled = true;
            btnSuggestPersona.textContent = 'ìƒì„± ì¤‘...';

            const prompt = "ë‹¹ì‹ ì€ ì°½ì˜ì ì¸ ì‘ê°€ì…ë‹ˆë‹¤. AI ì±„íŒ… ì•±ì—ì„œ ì‚¬ìš©í•  ìˆ˜ ìˆëŠ” ë…íŠ¹í•˜ê³  ì¬ë¯¸ìˆëŠ” 'ìºë¦­í„° í˜ë¥´ì†Œë‚˜' ì•„ì´ë””ì–´ 3ê°€ì§€ë¥¼ ì¶”ì²œí•´ ì£¼ì„¸ìš”. ê° ì•„ì´ë””ì–´ëŠ” 2~3ì¤„ë¡œ ì„¤ëª…í•˜ê³ , '---'ë¡œ êµ¬ë¶„í•´ ì£¼ì„¸ìš”.";
            
            try {
                const text = await callGeminiApi(
                    [{ role: "user", parts: [{ text: prompt }] }],
                    null, // ë³„ë„ ì‹œìŠ¤í…œ í”„ë¡¬í”„íŠ¸ ì—†ìŒ
                    userApiKey // âœ¨ API í‚¤ ì „ë‹¬
                );
                
                if (text.trim() === "") {
                     displayMessage('âœ¨ ì¶”ì²œí•  ì•„ì´ë””ì–´ê°€ ë– ì˜¤ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ ì£¼ì„¸ìš”.', 'error');
                } else {
                    charPersonaInput.value = text;
                    displayMessage('âœ¨ AIê°€ ìƒˆë¡œìš´ í˜ë¥´ì†Œë‚˜ ì•„ì´ë””ì–´ë¥¼ ì¶”ì²œí–ˆìŠµë‹ˆë‹¤. ì‚¬ì´ë“œë°”ë¥¼ í™•ì¸í•˜ì„¸ìš”!', 'model');
                }

            } catch (error) {
                console.error("Error in handleSuggestPersona:", error);
                displayMessage(`í˜ë¥´ì†Œë‚˜ ì¶”ì²œ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: ${error.message}`, 'error');
            } finally {
                btnSuggestPersona.disabled = false;
                btnSuggestPersona.textContent = originalText;
            }
        }

        /**
         * âœ¨ ìƒˆ ê¸°ëŠ¥: ëŒ€í™”ì—ì„œ ê¸°ì–µ ì¶”ì¶œ
         */
        async function handleExtractMemory(e) {
            e.preventDefault();
            
            // âœ¨ NEW: API í‚¤ ì²´í¬
            if (!userApiKey) {
                 displayMessage("API í‚¤ê°€ ì—†ìŠµë‹ˆë‹¤. 'âœ¨ ê¸°ì–µ ì¶”ì¶œ' ê¸°ëŠ¥ì„ ì‚¬ìš©í•˜ë ¤ë©´ ë¨¼ì € í‚¤ë¥¼ ì €ì¥í•˜ì„¸ìš”.", 'error');
                 if (window.innerWidth < 768) btnOpenSidebar.click();
                 return;
            }
            
            if (chatHistory.length === 0) {
                displayMessage('ì•„ì§ ëŒ€í™” ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.', 'error');
                return;
            }

            const originalText = btnExtractMemory.textContent;
            btnExtractMemory.disabled = true;
            btnExtractMemory.textContent = 'ì¶”ì¶œ ì¤‘...';

            const systemPrompt = `
ë‹¹ì‹ ì€ ë§¤ìš° ê¼¼ê¼¼í•œ ë¹„ì„œì…ë‹ˆë‹¤.
ì œê³µë˜ëŠ” ëŒ€í™” ë‚´ì—­(\`contents\`)ì„ ë¶„ì„í•˜ì—¬, 'user'(ì‚¬ìš©ì)ì— ëŒ€í•œ í•µì‹¬ ì •ë³´(ì´ë¦„, ë‚˜ì´, ì¢‹ì•„í•˜ëŠ” ê²ƒ, ì‹«ì–´í•˜ëŠ” ê²ƒ, ì•½ì†, ì¤‘ìš”í•œ ì‚¬ê±´ ë“±)ë¥¼ ìš”ì•½í•´ ì£¼ì„¸ìš”.
'ì¥ê¸° ê¸°ì–µ' íƒ­ì— ì¶”ê°€í•  ìˆ˜ ìˆë„ë¡, ê° í•­ëª©ì„ ê¸€ë¨¸ë¦¬ ê¸°í˜¸(-)ë¡œ êµ¬ë¶„í•˜ì—¬ ëª©ë¡ìœ¼ë¡œë§Œ ì‘ë‹µí•´ ì£¼ì„¸ìš”.
AIë‚˜ ì‹œìŠ¤í…œì— ëŒ€í•œ ì •ë³´ëŠ” ì œì™¸í•˜ê³ , ì˜¤ì§ 'user'ì— ëŒ€í•œ ì‚¬ì‹¤ë§Œ ì¶”ì¶œí•©ë‹ˆë‹¤.
            `.trim();

            try {
                const text = await callGeminiApi(
                    chatHistory, 
                    systemPrompt,
                    userApiKey // âœ¨ API í‚¤ ì „ë‹¬
                );
                
                if (text.trim() === "") {
                    displayMessage('âœ¨ ë¶„ì„ ì™„ë£Œ. ëŒ€í™”ì—ì„œ ì¶”ì¶œí•  ë§Œí•œ íŠ¹ë³„í•œ ê¸°ì–µì„ ì°¾ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.', 'model');
                } else {
                    const existingMemory = memoryInput.value.trim();
                    memoryInput.value = existingMemory + (existingMemory ? '\n' : '') + text;
                    displayMessage('âœ¨ ëŒ€í™”ì—ì„œ ì£¼ìš” ì •ë³´ë¥¼ ì¶”ì¶œí•˜ì—¬ [ì¥ê¸° ê¸°ì–µ] íƒ­ì— ì¶”ê°€í–ˆìŠµë‹ˆë‹¤. ì‚¬ì´ë“œë°”ë¥¼ í™•ì¸í•˜ì„¸ìš”!', 'model');
                }
            } catch (error) {
                console.error("Error in handleExtractMemory:", error);
                displayMessage(`ê¸°ì–µ ì¶”ì¶œ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: ${error.message}`, 'error');
            } finally {
                btnExtractMemory.disabled = false;
                btnExtractMemory.textContent = originalText;
            }
        }

        /**
         * âœ¨ API í˜¸ì¶œ ê³µí†µ í•¨ìˆ˜ (ìˆ˜ì •ë¨)
         * @param {Array} contents - ì „ì†¡í•  ëŒ€í™” ë‚´ì—­
         * @param {string|null} systemInstructionText - ì ìš©í•  ì‹œìŠ¤í…œ í”„ë¡¬í”„íŠ¸
         * @param {string} apiKey - ì‚¬ìš©ìê°€ ì…ë ¥í•œ API í‚¤
         * @returns {Promise<string>} - AI ì‘ë‹µ í…ìŠ¤íŠ¸
         */
        async function callGeminiApi(contents, systemInstructionText, apiKey) {
            
            // âœ¨ NEW: API í‚¤ê°€ ì—†ìœ¼ë©´ ì¦‰ì‹œ ì˜¤ë¥˜ ë°˜í™˜
            if (!apiKey) {
                throw new Error("API key is missing.");
            }

            // âœ¨ NEW: API URL ë™ì  ìƒì„±
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/${modelName}:generateContent?key=${apiKey}`;

            // âœ¨ yì˜ ìš”ì²­ìœ¼ë¡œ ì•ˆì „ ì„¤ì •ì„ 'BLOCK_NONE' (ì°¨ë‹¨ ì•ˆí•¨)ìœ¼ë¡œ ê³ ì •
            const safetyThreshold = "BLOCK_NONE"; 
            
            const safetySettings = [
                { category: "HARM_CATEGORY_HARASSMENT", threshold: safetyThreshold },
                { category: "HARM_CATEGORY_HATE_SPEECH", threshold: safetyThreshold },
                { category: "HARM_CATEGORY_SEXUALLY_EXPLICIT", threshold: safetyThreshold },
                { category: "HARM_CATEGORY_DANGEROUS_CONTENT", threshold: safetyThreshold },
            ];

            const payload = {
                contents: contents,
                safetySettings: safetySettings
            };

            if (systemInstructionText) {
                payload.systemInstruction = {
                    parts: [{ text: systemInstructionText }]
                };
            }

            const response = await fetchWithRetry(apiUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            if (!response.ok) {
                // âœ¨ NEW: 401, 403 ë“± ì¸ì¦ ì˜¤ë¥˜ ëª…ì‹œ
                if (response.status === 401 || response.status === 403) {
                     throw new Error(`API key not valid or unauthorized (status: ${response.status})`);
                }
                throw new Error(`API error! status: ${response.status}`);
            }

            const result = await response.json();

            if (result.promptFeedback) {
                console.error("Prompt Feedback:", result.promptFeedback);
                const blockReason = result.promptFeedback.blockReason || 'ì•Œ ìˆ˜ ì—†ëŠ” ì´ìœ ';
                throw new Error(`ì…ë ¥ì´ ì°¨ë‹¨ë˜ì—ˆìŠµë‹ˆë‹¤. (ì´ìœ : ${blockReason})`);
            }
            
            const candidate = result.candidates?.[0];

            if (candidate) {
                if (candidate.finishReason === 'STOP') {
                    if (candidate.content && 
                        candidate.content.parts && 
                        candidate.content.parts.length > 0 &&
                        candidate.content.parts[0].text != null 
                    ) {
                        return candidate.content.parts[0].text;
                    } else {
                        return ""; 
                    }
                } else {
                    if (safetyThreshold === "BLOCK_NONE" && candidate.finishReason === "SAFETY") {
                        return "(ì‹œìŠ¤í…œ: AIì˜ ì‘ë‹µì´ ì•ˆì „ ì„¤ì •ì— ì˜í•´ ì°¨ë‹¨ë˜ì—ˆìŠµë‹ˆë‹¤.)";
                    }
                    throw new Error(`APIê°€ ì •ìƒ ì¢…ë£Œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. (ì´ìœ : ${candidate.finishReason || 'ì•Œ ìˆ˜ ì—†ìŒ'})`);
                }
            } else {
                 if (result.promptFeedback) {
                    const blockReason = result.promptFeedback.blockReason || 'ì•Œ ìˆ˜ ì—†ìŒ';
                     throw new Error(`ì…ë ¥ì´ ì°¨ë‹¨ë˜ì—ˆìŠµë‹ˆë‹¤. (ì´Yìœ : ${blockReason})`);
                }
                throw new Error("APIë¡œë¶€í„° ìœ íš¨í•œ ì‘ë‹µ(candidates)ì„ ë°›ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.");
            }
        }


        /**
         * 3. ì‹œìŠ¤í…œ í”„ë¡¬í”„íŠ¸ ìƒì„± (í•µì‹¬ ê¸°ëŠ¥)
         */
        function buildSystemPrompt() {
            const charPersona = charPersonaInput.value;
            const userPersona = userPersonaInput.value;
            const worldview = worldviewInput.value;
            const memory = memoryInput.value;

            let prompt = `
ë‹¹ì‹ ì€ 'AI í˜ë¥´ì†Œë‚˜' ì—­í• ì„ ìˆ˜í–‰í•˜ëŠ” AIì…ë‹ˆë‹¤. ë‹¹ì‹ ì˜ ìœ ì¼í•œ ëª©í‘œëŠ” ì•„ë˜ ì„¤ì •ì— ì™„ë²½í•˜ê²Œ ëª°ì…í•˜ì—¬ ì‚¬ìš©ìì™€ ëŒ€í™”í•˜ëŠ” ê²ƒì…ë‹ˆë‹¤.

### 1. ë‹¹ì‹ ì˜ í˜ë¥´ì†Œë‚˜ (AI ì—­í• ) ###
${charPersona || "ë‹¹ì‹ ì€ ì¹œì ˆí•œ AI ì–´ì‹œìŠ¤í„´íŠ¸ì…ë‹ˆë‹¤."}

### 2. ì‚¬ìš©ìì˜ í˜ë¥´ì†Œë‚˜ (ëŒ€í™” ìƒëŒ€) ###
${userPersona || "í‰ë²”í•œ ì‚¬ìš©ìì…ë‹ˆë‹¤."}

### 2.5. ë°°ê²½ ì„¸ê³„ê´€ (World Setting) ###
ë‹¹ì‹ ê³¼ ì‚¬ìš©ìëŠ” ë‹¤ìŒ ì„¸ê³„ê´€ì„ ë°°ê²½ìœ¼ë¡œ ëŒ€í™”í•©ë‹ˆë‹¤. ì´ ì„¤ì •ì— ëª°ì…í•˜ì„¸ìš”.
${worldview || "íŠ¹ë³„íˆ ì„¤ì •ëœ ì„¸ê³„ê´€ì€ ì—†ìŠµë‹ˆë‹¤. (í˜„ëŒ€ ì¼ìƒ)"}

### 3. ì¥ê¸° ê¸°ì–µ (í•„ìˆ˜ ì „ì œ ì¡°ê±´) ###
ë‹¹ì‹ ì€ ë‹¤ìŒ ì •ë³´ë¥¼ ëŒ€í™”ì˜ í•µì‹¬ ì „ì œë¡œ ì‚¼ê³ , *ì ˆëŒ€* ìŠì§€ ë§ì•„ì•¼ í•©ë‹ˆë‹¤.
${memory || "íŠ¹ë³„íˆ ê¸°ì–µí•  ì‚¬í•­ì€ ì—†ìŠµë‹ˆë‹¤."}

---
### 4. í•µì‹¬ í–‰ë™ ì§€ì¹¨ (ê°€ì¥ ì¤‘ìš”) ###
1.  **ìµœìš°ì„  ìˆœìœ„**: ë‹¹ì‹ ì˜ ì‘ë‹µì€ [3. ì¥ê¸° ê¸°ì–µ]ê³¼ ë°”ë¡œ ì§ì „ì˜ ëŒ€í™” ë§¥ë½(\`contents\`)ì„ ìµœìš°ì„ ìœ¼ë¡œ ê³ ë ¤í•´ì•¼ í•©ë‹ˆë‹¤.
2.  **ì¼ê´€ì„± ìœ ì§€**: ë‹¹ì‹ ì˜ ì‘ë‹µì€ [1. ë‹¹ì‹ ì˜ í˜ë¥´ì†Œë‚˜] ì„¤ì •ê³¼ ì ˆëŒ€ë¡œ ëª¨ìˆœë˜ì–´ì„œëŠ” ì•ˆ ë©ë‹ˆë‹¤.
3.  **ë°˜ë³µ ê¸ˆì§€**: ë°”ë¡œ ì§ì „ ëŒ€í™”(\`contents\`ì˜ ë§ˆì§€ë§‰ \`model\` ì‘ë‹µ)ì—ì„œ í–ˆë˜ ë§ì„ ê·¸ëŒ€ë¡œ ë°˜ë³µí•˜ì§€ ë§ˆì„¸ìš”.
4.  **ì„¤ì • ì–¸ê¸‰ ê¸ˆì§€**: ë‹¹ì‹ ì˜ í˜ë¥´ì†Œë‚˜, ì‚¬ìš©ìì˜ í˜ë¥´ì†Œë‚˜, ë˜ëŠ” ì´ ì§€ì¹¨ ìì²´ì— ëŒ€í•´ *ì ˆëŒ€* ì§ì ‘ì ìœ¼ë¡œ ì–¸ê¸‰í•˜ì§€ ë§ˆì„¸ìš”. (ì˜ˆ: "ì €ëŠ” ì§‘ì‚¬ ê³ ì–‘ì…ë‹ˆë‹¤", "ë‹¹ì‹ ì€ ì œ ì£¼ì¸ë‹˜ì´ì‹œì£ " ê°™ì€ 'ì„¤ì •'ì„ ì„¤ëª…í•˜ëŠ” ë§ì„ í•˜ì§€ ë§ê³ , ê·¸ëƒ¥ ê·¸ ì—­í• ì— ë§ì¶° ìì—°ìŠ¤ëŸ½ê²Œ í–‰ë™í•˜ì„¸ìš”.)
5.  **ì—°ì†ì„±**: \`contents\` (ëŒ€í™” ë‚´ì—­)ë¥¼ ë°”íƒ•ìœ¼ë¡œ ëŒ€í™”ë¥¼ ìì—°ìŠ¤ëŸ½ê²Œ ì´ì–´ê°€ì„¸ìš”.
`;
            return prompt.trim();
        }

        /**
         * 4. ì±„íŒ…ì°½ì— ë©”ì‹œì§€ ë²„ë¸” ì¶”ê°€
         */
        function displayMessage(message, role, messageId) {
            const bubble = document.createElement('div');
            bubble.classList.add('p-3', 'rounded-lg', 'max-w-xs', 'md:max-w-md', 'lg:max-w-2xl', 'break-words', 'group', 'relative');
            
            if (messageId) {
                bubble.dataset.id = messageId;
            }
            
            let htmlContent = '';
            
            if (role === 'user') {
                bubble.classList.add('bg-blue-600', 'self-end', 'ml-auto');
                htmlContent = `<span class="font-bold block text-blue-200">ğŸ‘¤ ë‚˜</span>`;
            } else if (role === 'model') {
                bubble.classList.add('bg-gray-700', 'self-start', 'mr-auto');
                htmlContent = `<span class="font-bold block text-blue-300">ğŸ¤– AI</span>`;
            } else { // 'error'
                bubble.classList.add('bg-red-700', 'self-start', 'mr-auto');
                htmlContent = `<span class="font-bold block text-red-200">ğŸš¨ ì‹œìŠ¤í…œ</span>`;
            }

            htmlContent += `<p class="text-white">${message.replace(/\n/g, '<br>')}</p>`;
            bubble.innerHTML = htmlContent;

            if (messageId) {
                const deleteButton = document.createElement('button');
                deleteButton.classList.add(
                    'btn-delete', 'text-gray-400', 'hover:text-white', 
                    'opacity-0', 'group-hover:opacity-100', 'transition-opacity', 
                    'absolute', 'top-1', 'right-1', 'p-1', 'rounded-full', 'leading-none', 'z-10'
                );
                deleteButton.innerHTML = '&#x2715;';
                deleteButton.setAttribute('aria-label', 'Delete message');
                bubble.appendChild(deleteButton);
            }

            chatDisplay.appendChild(bubble);
            chatDisplay.scrollTop = chatDisplay.scrollHeight;
        }

        /**
         * 5. API í˜¸ì¶œ ì¬ì‹œë„ í•¨ìˆ˜ (Exponential Backoff)
         */
        async function fetchWithRetry(url, options, retries = 3, delay = 1000) {
            let lastError;
            for (let i = 0; i < retries; i++) {
                try {
                    const response = await fetch(url, options);
                    // 429 (Too Many Requests) ë˜ëŠ” 503 (Service Unavailable) ì¼ ë•Œë§Œ ì¬ì‹œë„
                    if (response.status === 429 || response.status === 503) {
                        throw new Error(`Retryable error: ${response.status}`);
                    }
                    // 401, 403 ë“± í‚¤ ì¸ì¦ ì˜¤ë¥˜ëŠ” ì¬ì‹œë„í•˜ì§€ ì•Šê³  ì¦‰ì‹œ ë°˜í™˜
                    // (ì¬ì‹œë„í•´ë„ ì„±ê³µí•  ìˆ˜ ì—†ìœ¼ë¯€ë¡œ)
                    if (response.status === 401 || response.status === 403) {
                        return response; 
                    }
                    
                    // ê·¸ ì™¸ 4xx, 5xx ì˜¤ë¥˜
                    if (!response.ok) {
                         // ì¬ì‹œë„ ëŒ€ìƒì´ ì•„ë‹Œ ë‹¤ë¥¸ ì„œë²„ ì˜¤ë¥˜
                         // throw new Error(`Non-retryable error: ${response.status}`);
                         // ì¼ë‹¨ ì¬ì‹œë„ ë¡œì§ì„ íƒ€ë„ë¡ ìˆ˜ì • (ì¼ì‹œì  500 ì˜¤ë¥˜ ë“±)
                         throw new Error(`Server error: ${response.status}`);
                    }

                    return response; // ì„±ê³µ
                } catch (error) {
                    lastError = error;
                    // console.log(`Attempt ${i + 1} failed. Retrying in ${delay}ms...`);
                    await new Promise(res => setTimeout(res, delay));
                    delay *= 2; 
                }
            }
            if (!lastError) {
                lastError = new Error("Network request failed after retries.");
            }
            throw lastError;
        }

    </script>
</body>
</html>


